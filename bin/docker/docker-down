#!/bin/bash

# shellcheck source=../shell-common
source "${SHELL_BIN}/shell-common"

function estimate() {
  declare -a container_ids=($(docker container list --all --quiet))
  declare -i container_count="${#container_ids[@]}"

  declare -a container_running_ids=($(docker container list --all --filter "status=running" --quiet))
  declare -i container_running_count="${#container_running_ids[@]}"

  declare -a image_ids=($(docker images --all --quiet))
  declare -i image_count="${#image_ids[@]}"

  log_info "Containers all: ${container_count}"
  log_info "Containers running: ${container_running_count}"
  log_info "Images all: ${image_count}"
}

estimate
log_warn "Down docker! ğŸš›"

if (("${container_running_count:-0}" > 0)); then
  if docker container stop "${container_running_ids}"; then
    log_success "=> Stop ${container_running_count} containers âœ…"
  fi
fi

if docker container prune --force &>/dev/null; then
  log_success "=> Remove all stopped containers ğŸš’"
fi

if docker network prune --force &>/dev/null; then
  log_success "=> Remove all unused networks ğŸ–¥"
fi

if docker volume prune --force &>/dev/null; then
  log_success "=> Remove all unused local volumes âœ…"
fi

if docker image prune --all --force &>/dev/null; then
  log_success "=> Remove all unused local images ğŸš’"
fi

#if docker rmi --force $(docker images --all --quiet) &>/dev/null; then
#  log_success "=> Remove all images ğŸ–¼"
#fi

estimate
